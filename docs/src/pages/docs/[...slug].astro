---
import { getCollection, render } from "astro:content";
import type { CollectionEntry } from "astro:content";

import Page from "../../layouts/Page.astro";

import APITable from "../../components/APITable.astro";
import CodeBlock from "../../components/CodeBlock.astro";
import CodeDemo from "../../components/CodeDemo.astro";

import "../../styles/catalog.css";
import "../../styles/design-tokens/color-palette.css";
import "../../styles/design-tokens/shadows.css";
import "../../styles/design-tokens/spacing.css";
import "../../styles/design-tokens/transitions.css";
import "../../styles/layout/preview-wrapper.css";

export async function getStaticPaths() {
    const allPosts = (await getCollection("docs")) as CollectionEntry<"docs">[];

    const nonDefaultLocales = ["de"];

    const enPosts = allPosts.filter((post: CollectionEntry<"docs">) => {
        const firstSegment = post.id.split("/")[0];

        return !nonDefaultLocales.includes(firstSegment);
    });

    return enPosts.map((post: CollectionEntry<"docs">) => {
        const data = post.data;
        const customSlug = data.slug?.trim();

        let finalSlug;

        if (customSlug && customSlug !== "") {
            finalSlug = customSlug;
        } else {
            const fileSlug = post.id.replace(".md", "");
            finalSlug = fileSlug || undefined;
        }

        return {
            params: { slug: finalSlug },
            props: { post },
        };
    });
}

function titleToComponentName(title: string) {
    if (!title) {
        return "";
    }

    return (
        "Pc" +
        title
            .split(/\s+/)
            .map((word) => word[0].toUpperCase() + word.slice(1).toLowerCase())
            .join("")
    );
}

const { post } = Astro.props as { post: CollectionEntry<"docs"> };
const { Content } = await render(post);

const slug = (Astro.params as Record<string, string>).slug as string;

const isComponentPage = slug.startsWith("components/");
const componentName = isComponentPage
    ? titleToComponentName(post.data.title)
    : undefined;
---

<Page {...post.data} {...!isComponentPage ? {} : { component: componentName }}>
    <Content components={{ CodeBlock, CodeDemo }} />

    {isComponentPage && <APITable componentName={componentName ?? ""} />}
</Page>
