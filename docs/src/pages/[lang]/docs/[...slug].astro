---
import { getCollection, render } from "astro:content";
import Page from "../../../layouts/Page.astro";

import APITable from "../../../components/APITable.astro";
import CodeBlock from "../../../components/CodeBlock.astro";
import CodeDemo from "../../../components/CodeDemo.astro";

import "../../../styles/catalog.css";
import "../../../styles/design-tokens/color-palette.css";
import "../../../styles/design-tokens/shadows.css";
import "../../../styles/design-tokens/spacing.css";
import "../../../styles/design-tokens/transitions.css";
import "../../../styles/layout/preview-wrapper.css";

export async function getStaticPaths() {
    const allDocs = await getCollection("docs");

    const defaultLocale = "en";
    const targetLocales = ["de"];
    const pathsToGenerate = [];
    const defaultDocsSlugs = new Set();

    for (const post of allDocs) {
        const idParts = post.id.split("/");

        if (
            idParts[0] === defaultLocale ||
            !targetLocales.includes(idParts[0])
        ) {
            const slug = (
                idParts[0] === defaultLocale ? idParts.slice(1) : idParts
            ).join("/");

            defaultDocsSlugs.add(slug);
        }
    }

    for (const targetSlug of defaultDocsSlugs) {
        const defaultPost = allDocs.find((post) => {
            const idParts = post.id.split("/");
            const postSlug = (
                idParts[0] === defaultLocale ? idParts.slice(1) : idParts
            ).join("/");

            return (
                postSlug === targetSlug &&
                (idParts[0] === defaultLocale ||
                    !targetLocales.includes(idParts[0]))
            );
        });

        if (!defaultPost) {
            continue;
        }

        for (const lang of targetLocales) {
            const localizedPost = allDocs.find((post) =>
                post.id.startsWith(lang + "/" + targetSlug),
            );
            const postToRender = localizedPost || defaultPost;
            const isFallback = !localizedPost;
            const data = postToRender.data;
            const customSlug = data.slug?.trim();

            let finalSlugParameter;

            if (customSlug && customSlug !== "") {
                finalSlugParameter = customSlug;
            } else {
                finalSlugParameter =
                    targetSlug === "index" ? undefined : targetSlug;
            }

            pathsToGenerate.push({
                params: {
                    lang: lang,
                    slug: finalSlugParameter,
                },
                props: {
                    post: postToRender,
                    isFallback: isFallback,
                    requestedLocale: lang,
                },
            });
        }
    }

    return pathsToGenerate;
}

function titleToComponentName(title: string) {
    if (!title) {
        return "";
    }

    return (
        "Pc" +
        title
            .split(/\s+/)
            .map((word) => word[0].toUpperCase() + word.slice(1).toLowerCase())
            .join("")
    );
}

const { post, isFallback } = Astro.props;
const { Content, headings } = await render(post);

const slug = Astro.params.slug as string;

const isComponentPage = slug.startsWith("components/");
const componentName = isComponentPage
    ? titleToComponentName(post.data.title)
    : undefined;
---

<Page
    {...post.data}
    headings={headings}
    isFallback={isFallback}
    {...!isComponentPage ? {} : { component: componentName }}
>
    <Content components={{ CodeBlock, CodeDemo }} />

    {isComponentPage && <APITable componentName={componentName ?? ""} />}
</Page>
