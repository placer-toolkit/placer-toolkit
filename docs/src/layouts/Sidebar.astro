---
import { getLanguageFromURL, useTranslations } from "../i18n/utilities.js";
import { getCollection, type CollectionEntry } from "astro:content";

type SidebarLink = {
    title: string;
    href: string;
    isChildOf: string | undefined | null;
    order: number;
    children?: SidebarLink[];
    isUntranslated?: boolean;
};

type SidebarCategoryConfiguration = {
    id: string;
    title: string;
    sortType: "manual" | "alphabetical";
    href?: string;
    icon?: string;
};

type SidebarCategory = SidebarCategoryConfiguration & {
    links: SidebarLink[];
};

type GroupedLinks = {
    [categoryId: string]: SidebarLink[];
};

const categoriesConfiguration: SidebarCategoryConfiguration[] = [
    { id: "get-started", title: "Get started", sortType: "manual" },
    {
        id: "design-tokens",
        title: "Design tokens",
        sortType: "manual",
        href: "/docs/design-tokens",
    },
    {
        id: "components",
        title: "Components",
        sortType: "alphabetical",
        href: "/docs/components",
        icon: "flask",
    },
    {
        id: "layout",
        title: "Layout",
        sortType: "alphabetical",
        href: "/docs/layout",
    },
    {
        id: "style-utilities",
        title: "Style utilities",
        sortType: "alphabetical",
        href: "/docs/style-utilities",
    },
    { id: "resources", title: "Resources", sortType: "manual" },
];

const language = getLanguageFromURL(Astro.url);
const defaultLanguage = "en";
const prefixLanguages = ["de"];

const allDocs = await getCollection("docs");
const englishContentMap = new Map<string, CollectionEntry<"docs">>();

allDocs.forEach((entry) => {
    const isEnglish = !prefixLanguages.some((prefix) =>
        entry.id.startsWith(`${prefix}/`),
    );

    if (isEnglish) {
        englishContentMap.set(entry.id, entry);
    }
});

let currentLanguageDocs = allDocs.filter((entry) => {
    if (prefixLanguages.includes(language)) {
        return entry.id.startsWith(`${language}/`);
    }

    return !prefixLanguages.some((prefix) => entry.id.startsWith(`${prefix}/`));
});

function buildSidebarData(
    currentLanguageDocs: CollectionEntry<"docs">[],
    englishContentMap: Map<string, CollectionEntry<"docs">>,
): SidebarCategory[] {
    const groupedLinks: GroupedLinks = {};

    const translatedIds = new Set(
        currentLanguageDocs.map((entry) =>
            entry.id.replace(`${language}/`, ""),
        ),
    );

    if (language === defaultLanguage) {
        for (const [englishId, englishEntry] of englishContentMap.entries()) {
            const categoryId = englishId.split("/")[0];
            const href = `/docs/${englishId}`;

            if (!categoryId) {
                continue;
            }

            if (!groupedLinks[categoryId]) {
                groupedLinks[categoryId] = [];
            }

            groupedLinks[categoryId].push({
                title: englishEntry.data.title,
                href: href,
                isChildOf: englishEntry.data.isChildOf ?? undefined,
                order: englishEntry.data.order ?? 10000,
                isUntranslated: false,
            });
        }
    } else {
        currentLanguageDocs.forEach((entry) => {
            const pathSegment = entry.id.replace(`${language}/`, "");
            const categoryId = pathSegment.split("/")[0];
            const href = `/${language}/docs/${pathSegment}`;

            if (!categoryId) {
                return;
            }

            if (!groupedLinks[categoryId]) {
                groupedLinks[categoryId] = [];
            }

            groupedLinks[categoryId].push({
                title: entry.data.title,
                href: href,
                isChildOf: entry.data.isChildOf ?? undefined,
                order: entry.data.order ?? 10000,
                isUntranslated: false,
            });
        });

        for (const [englishId, englishEntry] of englishContentMap.entries()) {
            if (!translatedIds.has(englishId)) {
                const categoryId = englishId.split("/")[0];

                if (!categoryId) {
                    continue;
                }

                if (!groupedLinks[categoryId]) {
                    groupedLinks[categoryId] = [];
                }

                const expectedLangHref = `/${language}/docs/${englishId}`;

                const isAlreadyPresent = groupedLinks[categoryId].some(
                    (link) =>
                        link.href === expectedLangHref ||
                        link.href === `/docs/${englishId}`,
                );

                if (!isAlreadyPresent) {
                    groupedLinks[categoryId].push({
                        title: englishEntry.data.title,
                        href: expectedLangHref,
                        isChildOf: englishEntry.data.isChildOf ?? undefined,
                        order: englishEntry.data.order ?? 10000,
                        isUntranslated: true,
                    });
                }
            }
        }
    }

    return categoriesConfiguration.map((category) => {
        let links: SidebarLink[] = groupedLinks[category.id] || [];

        let mutableLinks = [...links];

        if (category.sortType === "alphabetical") {
            let parentLinks = mutableLinks.filter(
                (link) => !link.isChildOf,
            ) as SidebarLink[];
            let childLinks = mutableLinks.filter(
                (link) => link.isChildOf,
            ) as SidebarLink[];

            parentLinks.sort((a, b) => a.title.localeCompare(b.title));

            const parentMap = new Map<string, SidebarLink>();

            parentLinks.forEach((link) => {
                link.children = [];
                parentMap.set(link.title, link);
            });

            childLinks.forEach((child) => {
                const parent = parentMap.get(child.isChildOf!);

                if (parent) {
                    parent.children!.push(child);
                } else {
                    parentLinks.push(child);
                }
            });

            parentLinks.forEach((parent) => {
                if (parent.children && parent.children.length > 0) {
                    parent.children.sort((a, b) =>
                        a.title.localeCompare(b.title),
                    );
                }
            });

            mutableLinks = parentLinks;
        } else if (category.sortType === "manual") {
            mutableLinks.sort((a, b) => a.order - b.order);
        }

        return { ...category, links: mutableLinks };
    });
}

const translation = useTranslations(language);

const sidebarNavigation = buildSidebarData(
    currentLanguageDocs,
    englishContentMap,
);
---

<aside class="sidebar" role="complementary" aria-label="Sidebar" tabindex="-1">
    <nav aria-label="Sidebar navigation">
        {
            sidebarNavigation.map((category) => (
                <pc-details variant="outlined" data-id={category.id}>
                    <span slot="summary">
                        {category.href ? (
                            <a class="summary-link" href={category.href}>
                                {category.title}
                                {category.icon && (
                                    <pc-icon
                                        library="default"
                                        icon-style="solid"
                                        name={category.icon}
                                    />
                                )}
                            </a>
                        ) : (
                            category.title
                        )}
                    </span>

                    <ul>
                        {category.links.map((link) => (
                            <>
                                <li>
                                    <a
                                        class:list={{
                                            "untranslated-flag":
                                                link.isUntranslated,
                                        }}
                                        href={link.href}
                                    >
                                        {link.title}
                                        {link.isUntranslated && (
                                            <span class="pc-visually-hidden">
                                                {translation(
                                                    "content.englishOnly",
                                                )}
                                            </span>
                                        )}
                                    </a>

                                    {link.children &&
                                        link.children.length > 0 && (
                                            <ul>
                                                {link.children.map((child) => (
                                                    <li>
                                                        <a
                                                            class:list={{
                                                                "untranslated-flag":
                                                                    child.isUntranslated,
                                                            }}
                                                            href={child.href}
                                                        >
                                                            {child.title}
                                                            {child.isUntranslated && (
                                                                <span class="">
                                                                    {translation(
                                                                        "content.englishOnly",
                                                                    )}
                                                                </span>
                                                            )}
                                                        </a>
                                                    </li>
                                                ))}
                                            </ul>
                                        )}
                                </li>
                            </>
                        ))}
                        {category.id === "resources" && (
                            <li>
                                <a
                                    href="https://github.com/placer-toolkit/placer-toolkit/discussions"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                >
                                    Support
                                    <pc-icon
                                        class="external-link"
                                        library="default"
                                        icon-style="solid"
                                        name="arrow-up"
                                    />
                                </a>
                            </li>
                        )}
                    </ul>
                </pc-details>
            ))
        }

        <div class="other-links">
            <div class="pc-cluster">
                <button data-dialog="open contact-info">Contact</button>
                <a href="/docs/legal/privacy">Privacy</a>
                <a href="/docs/legal/code-of-conduct">Code of Conduct</a>
                <a href="/docs/legal/licence">Licence</a>
                <a href="/docs/legal/impressum">Impressum</a>
            </div>

            <span class="attribution">
                © 2025 Placer •
                <a href="https://astro.build">
                    <img
                        src="https://astro.badg.es/v2/built-with-astro/tiny.svg"
                        alt="Built with Astro"
                    />
                </a>
            </span>
        </div>
    </nav>
</aside>

<script>
    import type { PcDetails } from "placer-toolkit/dist/components/details/details.js";

    declare global {
        interface Window {
            __sidebarLinks__: string[];
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        const currentPath = window.location.pathname.replace(/\/$/, "");
        const links = document.querySelectorAll(".sidebar nav a");
        const detailsElements = document.querySelectorAll<PcDetails>(
            ".sidebar pc-details",
        );

        links.forEach((link) => {
            const href = link.getAttribute("href");
            const linkPath = href ? href.replace(/\/$/, "") : "";
            if (linkPath === currentPath) {
                link.setAttribute("aria-current", "page");
            } else {
                link.removeAttribute("aria-current");
            }
        });

        const sidebarLinks = Array.from(
            document.querySelectorAll(".sidebar pc-details a"),
        )
            .map((a) => a.getAttribute("href"))
            .filter(
                (href) =>
                    href &&
                    !href.startsWith("http") &&
                    !href.startsWith("/docs/legal"),
            );

        window.__sidebarLinks__ = sidebarLinks as string[];

        function updateSidebarState() {
            setTimeout(() => {
                const currentlyOpen = Array.from(detailsElements)
                    .filter(
                        (detail) =>
                            detail.hasAttribute("open") &&
                            detail.getAttribute("data-id"),
                    )
                    .map((detail) => detail.getAttribute("data-id"))
                    .filter((id): id is string => id !== null);
                localStorage.setItem(
                    "open-sidebar-sections",
                    JSON.stringify(currentlyOpen),
                );
            }, 0);
        }

        let isInitializing = true;

        detailsElements.forEach((element) => {
            const id = element.getAttribute("data-id");

            if (!id) {
                return;
            }

            element.addEventListener("pc-show", () => {
                if (!isInitializing) {
                    updateSidebarState();
                }
            });

            element.addEventListener("pc-hide", () => {
                if (!isInitializing) {
                    updateSidebarState();
                }
            });
        });

        try {
            const stored = localStorage.getItem("open-sidebar-sections");
            const openIds = stored ? JSON.parse(stored) : ["get-started"];

            detailsElements.forEach((element) => {
                const id = element.getAttribute("data-id");

                if (id) {
                    if (openIds.includes(id)) {
                        element.show();
                    } else {
                        element.hide();
                    }
                }
            });
        } catch (error) {
            console.warn(`Could not restore sidebar state: ${error}`);
            detailsElements.forEach((element) => {
                const id = element.getAttribute("data-id");
                if (id === "get-started") {
                    element.show();
                } else {
                    element.hide();
                }
            });
        }

        setTimeout(() => {
            isInitializing = false;
        }, 100);
    });

    const summaryLinks = document.querySelectorAll(".sidebar .summary-link");

    summaryLinks.forEach((link) => {
        link.addEventListener("click", (event) => {
            event.stopPropagation();
        });

        link.addEventListener("keydown", (event) => {
            event.stopPropagation();
        });
    });
</script>

<style>
    .sidebar {
        grid-area: sidebar;
        position: sticky;
        inset-block-start: 3.5rem;
        inset-inline-start: 0;
        padding: var(--pc-spacing-l);
        background-color: var(--pc-color-surface-default);
        border-inline-end: var(--pc-panel-border-width)
            var(--pc-panel-border-style) var(--pc-color-surface-border);
        min-inline-size: 300px;
        max-inline-size: 300px;
        block-size: calc(100dvh - 3.5rem);
        z-index: 2;
        overflow-y: auto;
    }

    .sidebar pc-details:not(:last-of-type) {
        margin-block-end: var(--pc-spacing-s);
    }

    .sidebar pc-details::part(base) {
        background-color: transparent;
    }

    .sidebar pc-details::part(summary) {
        font-weight: var(--pc-font-weight-bold);
    }

    .sidebar pc-details span[slot="summary"] a {
        color: var(--pc-color-text-normal);
        text-decoration: none;
    }

    .sidebar pc-details span[slot="summary"] a pc-icon {
        color: color-mix(in oklab, currentColor, var(--pc-color-mix-hover));
    }

    @media (hover: hover) {
        .sidebar pc-details span[slot="summary"] a:hover {
            color: color-mix(
                in oklab,
                var(--pc-color-text-link),
                var(--pc-color-mix-hover)
            );
        }
    }

    .sidebar pc-details span[slot="summary"] a:active {
        color: color-mix(
            in oklab,
            var(--pc-color-text-link),
            var(--pc-color-mix-active)
        );
    }

    .sidebar pc-details ul {
        display: flex;
        flex-direction: column;
        gap: var(--pc-spacing-s);
        margin-inline-start: var(--pc-spacing-xs);
        padding-inline-start: var(--pc-spacing-l);
        border-inline-start: var(--pc-border-width-s) var(--pc-border-style)
            var(--pc-color-neutral-border-quiet);
        list-style: none;
    }

    .sidebar pc-details > ul {
        margin-block-start: calc(-1 * var(--pc-spacing-l));
    }

    .sidebar pc-details ul li a {
        margin-inline-start: calc(
            -1 * (var(--pc-spacing-l) + var(--pc-border-width-s))
        );
        padding-inline-start: calc(
            var(--pc-spacing-l) - var(--pc-border-width-s)
        );
        color: color-mix(
            in oklab,
            var(--pc-color-text-normal),
            var(--pc-color-surface-default) 15%
        );
        border-radius: 0;
        border-inline-start: var(--pc-border-width-s) var(--pc-border-style)
            transparent;
        font-weight: var(--pc-font-weight-normal);
        text-decoration: none;
    }

    .sidebar pc-details ul li a.untranslated-flag::after {
        content: "EN";
        font-size: calc(var(--pc-font-size-smaller) / 1.25);
        vertical-align: super;
    }

    @media (hover: hover) {
        .sidebar pc-details ul li a:hover {
            color: var(--pc-color-text-normal);
            border-color: var(--pc-color-neutral-on-quiet);
        }
    }

    .sidebar pc-details ul li a:active {
        color: color-mix(
            in oklab,
            var(--pc-color-text-normal),
            var(--pc-color-mix-active)
        );
        border-color: color-mix(
            in oklab,
            var(--pc-color-neutral-on-quiet),
            var(--pc-color-mix-active)
        );
    }

    .sidebar pc-details ul li a[aria-current="page"] {
        color: var(--pc-color-primary-on-quiet);
        border-color: var(--pc-color-primary-on-quiet);
        font-weight: var(--pc-font-weight-semibold);
    }

    .sidebar pc-details ul li a pc-icon.external-link {
        margin-inline-start: var(--pc-spacing-s);
        color: var(--pc-color-text-quiet);
        rotate: 45deg;
        translate: 0 0.125rem;
    }

    .sidebar pc-details ul li ul {
        margin-block-start: var(--pc-spacing-s);
    }

    .sidebar .other-links {
        margin-block-start: var(--pc-spacing-l);
        margin-inline: var(--pc-spacing-s);
    }

    .sidebar .other-links div.pc-cluster {
        row-gap: var(--pc-spacing-xxxs);
    }

    .sidebar .other-links button {
        all: unset;
        border-radius: var(--pc-border-radius-s);
        cursor: pointer;
        transition: all var(--pc-transition-fast) ease-in-out;
    }

    .sidebar .other-links button:focus-visible {
        outline: var(--pc-focus-ring);
        outline-offset: var(--pc-focus-ring-offset);
        animation: focus-ring-animation var(--pc-transition-medium)
            cubic-bezier(0.33, 1, 0.68, 1);
    }

    .sidebar .other-links button,
    .sidebar .other-links a {
        color: var(--pc-color-neutral-on-quiet);
        font-weight: var(--pc-font-weight-semibold);
        font-size: var(--pc-font-size-smaller);
        text-decoration: none;
    }

    @media (hover: hover) {
        .sidebar .other-links button:hover,
        .sidebar .other-links a:hover {
            color: color-mix(
                in oklab,
                var(--pc-color-neutral-on-quiet),
                var(--pc-color-mix-hover)
            );
            text-decoration: var(--pc-link-decoration-hover);
        }
    }

    .sidebar .other-links button:active,
    .sidebar .other-links a:active {
        color: color-mix(
            in oklab,
            var(--pc-color-neutral-on-quiet),
            var(--pc-color-mix-active)
        );
        text-decoration: var(--pc-link-decoration-active);
    }

    :global(.pc-theme-utility)
        .sidebar
        .other-links
        :is(button, a):is(:hover, :active) {
        color: var(--pc-color-text-normal);
    }

    .sidebar .other-links .attribution {
        display: inline-block;
        align-items: center;
        margin-block-start: var(--pc-spacing-xs);
        color: var(--pc-color-neutral-on-quiet);
        font-size: var(--pc-font-size-smaller);
        font-weight: var(--pc-font-weight-medium);
    }

    .sidebar .other-links .attribution img {
        position: relative;
        inset-block-start: var(--pc-spacing-xs);
        border-radius: 0;
    }

    @media screen and (max-width: 1440px) {
        .sidebar {
            display: none;
        }
    }
</style>
