---
import { getLanguageFromURL, useTranslations } from "../i18n/utilities.js";

import NavigationBar from "./NavigationBar.astro";
import Sidebar from "./Sidebar.astro";
import MobileSidebar from "./MobileSidebar.astro";

import ComponentInfo from "../components/ComponentInfo.astro";
import FallbackContentWarning from "../components/FallbackContentWarning.astro";
import Footer from "../components/Footer.astro";
import Search from "../components/Search.astro";

import "placer-toolkit/dist/styles/placer.css";
import "placer-toolkit/dist/styles/themes/utility.css";
import "placer-toolkit/dist/styles/themes/serene.css";
import "../styles/main.css";
import "../styles/fonts.css";
import "../styles/utilities.css";

const language = getLanguageFromURL(Astro.url);
const translation = useTranslations(language);

const {
    title = "Untitled",
    description = `${translation("landingCTA.tagline.flexible")} ${translation("landingCTA.tagline.accessible")} ${translation("landingCTA.tagline.webComponents")}`,
    component = "",
    hero = false,
    pagefindIgnore = false,
    noSidebar = false,
    showFooter = false
} = Astro.props;
---

<!doctype html>
<html
    lang={language}
    class:list={{ "pc-light": true, "no-sidebar": noSidebar }}
>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content={Astro.generator} />
        <meta name="description" content={description} />
        <meta
            name="keywords"
            content="lit, placer, toolkit, litelement, components, placer-toolkit, web-components, custom-elements"
        />
        <meta name="author" content="randomguy-2650" />
        <meta name="robots" content="index, follow" />
        <meta property="og:title" content="Placer Toolkit" />
        <meta
            property="og:description"
            content={`${translation("landingCTA.tagline.flexible")} ${translation("landingCTA.tagline.accessible")} ${translation("landingCTA.tagline.webComponents")}`}
        />
        <meta
            property="og:url"
            content={new URL(Astro.url.pathname, Astro.site).href}
        />
        <meta property="og:type" content="website" />
        <meta property="og:site_name" content="Placer Toolkit" />
        <link rel="icon" type="image/svg+xml" href="/brand/favicon.svg" />
        <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
        <!-- Placer Toolkit -->
        <script>
            import "placer-toolkit/dist/placer.js";

            import "placer-toolkit/dist/translations/en-gb.js";
            import "placer-toolkit/dist/translations/de.js";
        </script>
        <!-- Cabin Analytics -->
        <script src="https://scripts.withcabin.com/hello.js" async is:inline
        ></script>
        <title>{hero ? title : `${title} | Placer Toolkit`}</title>
    </head>
    <body></body>
        <div class="layout-container pc-cloak">
            <pc-button
                href="#main-content"
                appearance="neutral"
                variant="filled outlined"
                class="skip-to-main-content pc-visually-hidden"
                data-pagefind-ignore
            >
                Skip to main content
            </pc-button>

            <NavigationBar noSidebar={noSidebar} />

            <MobileSidebar />

            {!noSidebar ? <Sidebar /> : undefined}

            <Search />

            <noscript>
                This site requires JavaScript to function properly, as it uses
                JavaScript‚Äêreliant web technologies.
            </noscript>

            <main
                class:list={[{ hero: hero }]}
                id="main-content"
                tabindex="-1"
                data-pagefind-ignore={pagefindIgnore ? true : undefined}
            >
                {
                    !hero ? (
                        <div class="content-layout">
                            <article>
                                <pc-button
                                    href="#table-of-contents"
                                    appearance="neutral"
                                    variant="filled outlined"
                                    size="small"
                                    class="skip-to-toc pc-desktop-only pc-visually-hidden"
                                    data-pagefind-ignore
                                >
                                    Skip to table of contents
                                </pc-button>

                                <pc-details
                                    class="toc-mobile"
                                    summary={translation("ui.toc.onThisPage")}
                                    data-pagefind-ignore
                                >
                                    <ul class="toc-ul" data-overview={translation("ui.toc.overview")} />
                                </pc-details>

                                <header id="_top">
                                    <h1>{title}</h1>

                                    {component ? (
                                        <ComponentInfo
                                            componentName={component}
                                        />
                                    ) : (
                                        ""
                                    )}

                                    <FallbackContentWarning />
                                </header>
                                <slot />
                            </article>

                            <aside
                                class="toc toc-desktop"
                                id="table-of-contents"
                                data-pagefind-ignore
                            >
                                <pc-button
                                    href="#_top"
                                    appearance="neutral"
                                    variant="filled outlined"
                                    size="small"
                                    class="return-to-main-content pc-desktop-only pc-visually-hidden"
                                    data-pagefind-ignore
                                >
                                    Return to main content
                                </pc-button>
                                <h3 class="toc-heading">{translation("ui.toc.onThisPage")}</h3>
                                <pc-scroller
                                    class="toc-scroll-fade"
                                    orientation="vertical"
                                >
                                    <ul class="toc-ul" data-overview={translation("ui.toc.overview")} />
                                </pc-scroller>
                            </aside>
                        </div>
                    ) : (
                        <pc-callout class="hero-callout" appearance="primary" size="small">
                            <span slot="icon" style="user-select: none; -webkit-user-select: none">
                                üöÄ
                            </span>
                            <div class="pc-split">
                                <b style="flex: 1">
                                    {translation("getStartedBanner.readyToStart")}
                                </b>
                                <pc-button
                                    appearance="primary"
                                    size="small"
                                    href="/docs/get-started/installation"
                                >
                                    {translation("button.getStarted")}

                                    <pc-icon
                                        class="arrow-right-move"
                                        library="default"
                                        icon-style="solid"
                                        name="chevron-right"
                                        slot="suffix"
                                    ></pc-icon>
                                </pc-button>
                            </div>
                        </pc-callout>

                        <slot />
                    )
                }
            </main>

            {showFooter ? <Footer /> : undefined}
        </div>

        <pc-dialog label="Contact" id="contact-info">
            <p>
                We‚Äôd love to hear from you. Please reach out to us with any questions or
                inquiries you may have.
            </p>

            <p>
                You can contact us via e‚Äêmail at
                <a href="mailto:placer.coc.reports+contact@gmail.com">
                    placer.coc.reports+contact@gmail.com</a
                >.
            </p>

            <p>We look forward to hearing from you!</p>

            <pc-button
                appearance="primary"
                variant="plain"
                slot="footer"
                data-dialog="close"

            >
                <pc-icon library="default" icon-style="solid" name="phone" slot="prefix"
                ></pc-icon>
                Got it!
            </pc-button>
        </pc-dialog>

        <script>
            // Theme
            const prefersDark =
                window.matchMedia &&
                window.matchMedia("(prefers-color-scheme: dark)").matches;

            document.documentElement.classList.add(
                prefersDark ? "pc-dark" : "pc-light",
            );
            document.documentElement.classList.remove(
                prefersDark ? "pc-light" : "pc-dark",
            );

            // Mobile sidebar
            const mobileSidebar = document.querySelector(
                ".mobile-sidebar",
            ) as HTMLDialogElement;
            const sidebarToggle = document.querySelector(".sidebar-toggle");

            sidebarToggle?.addEventListener(
                "click",
                () => (mobileSidebar.open = true),
            );

            // TOC generation
            document.addEventListener("DOMContentLoaded", () => {
                const tocMobile = document.querySelector(".toc-mobile .toc-ul") as HTMLUListElement;
                const tocDesktop = document.querySelector(
                    ".toc-desktop .toc-ul",
                ) as HTMLUListElement;

                const headings = Array.from(
                    document.querySelectorAll("h2[id], h3[id]"),
                );
                const items = headings.map((element) => ({
                    depth: element.tagName === "H2" ? 2 : 3,
                    slug: element.id,
                    text: (() => {
                        let text = element.textContent?.trim() || "";
                        if (text.endsWith("#")) {
                            text = text.slice(0, -1).trim();
                        }
                        return text;
                    })(),
                }));

                function createTOCItem({
                    depth,
                    slug,
                    text,
                }: {
                    depth: number;
                    slug: string;
                    text: string;
                }) {
                    const li = document.createElement("li");
                    li.className = `toc-item depth-${depth}`;
                    const a = document.createElement("a");
                    a.href = `#${slug}`;
                    a.textContent = text;
                    li.appendChild(a);
                    return li;
                }

                const overviewItem = document.createElement("li");

                overviewItem.className = "toc-item depth-2";

                const overviewLink = document.createElement("a");

                overviewLink.href = "#_top";
                overviewLink.textContent = tocDesktop.dataset.overview ?? tocMobile.dataset.overview ?? "";
                overviewItem.appendChild(overviewLink);

                [tocMobile, tocDesktop].forEach((toc) => {
                    if (!toc) {
                        return;
                    }

                    toc.innerHTML = "";
                    toc.appendChild(overviewItem.cloneNode(true));

                    items.forEach((item) => {
                        if (item.depth > 1 && item.depth < 4) {
                            toc.appendChild(createTOCItem(item));
                        }
                    });
                });
            });

            // TOC scrollspy
            document.addEventListener("DOMContentLoaded", () => {
                const toc = document.querySelector(".toc-desktop");

                if (!toc) {
                    return;
                }

                const links = Array.from(toc.querySelectorAll(".toc-ul a"));
                const idToLink = new Map(
                    links.map((link) => [
                        link.getAttribute("href")?.slice(1),
                        link,
                    ]),
                );

                const observer = new IntersectionObserver(
                    (entries) => {
                        entries.forEach((entry) => {
                            if (entry.isIntersecting) {
                                const id = entry.target.id;

                                if (!id) {
                                    return;
                                }

                                links.forEach((link) =>
                                    link.classList.toggle(
                                        "active",
                                        link.getAttribute("href") === `#${id}`,
                                    ),
                                );
                            }
                        });
                    },
                    {
                        root: null,
                        rootMargin: "0px 0px -60% 0px",
                        threshold: 0,
                    },
                );

                idToLink.forEach((_link, id) => {
                    if (!id) {
                        return;
                    }

                    const heading = document.getElementById(id);

                    if (heading) {
                        observer.observe(heading);
                    }
                });

                function determineActiveFromPosition() {
                    const targetLine = window.innerHeight * 0.18;
                    let chosenId: string | null = null;
                    let chosenTop = -Infinity;

                    idToLink.forEach((_link, id) => {
                        if (!id) {
                            return;
                        }

                        const element = document.getElementById(id);

                        if (!element) {
                            return;
                        }

                        const top = element.getBoundingClientRect().top;

                        if (top <= targetLine && top > chosenTop) {
                            chosenTop = top;
                            chosenId = id;
                        }
                    });

                    if (!chosenId) {
                        let nearestId: string | null = null;
                        let nearestDistance = Infinity;

                        idToLink.forEach((_link, id) => {
                            if (!id) {
                                return;
                            }

                            const element = document.getElementById(id);

                            if (!element) {
                                return;
                            }

                            const distance = Math.abs(
                                element.getBoundingClientRect().top -
                                    targetLine,
                            );

                            if (distance < nearestDistance) {
                                nearestDistance = distance;
                                nearestId = id;
                            }
                        });
                        chosenId = nearestId;
                    }

                    if (chosenId) {
                        links.forEach((link) =>
                            link.classList.toggle(
                                "active",
                                link.getAttribute("href") === `#${chosenId}`,
                            ),
                        );
                    }
                }

                determineActiveFromPosition();

                window.addEventListener("load", determineActiveFromPosition);
                window.addEventListener("resize", determineActiveFromPosition);
            });
        </script>
    </body>
</html>
