---
import { getLanguageFromURL, useTranslations } from "../../i18n/utilities.js";

import DynamicTableOfContents from "../../components/DynamicTableOfContents.astro";

const language = getLanguageFromURL(Astro.url);
const translation = useTranslations(language);
---

<div class="toc mobile-toc pc-mobile-only">
    <pc-details>
        <div slot="summary">
            <span class="toggle">
                {translation("ui.toc.onThisPage")}

                <pc-icon
                    library="default"
                    icon-style="solid"
                    name="chevron-right"></pc-icon>
            </span>
        </div>

        <div class="toc-dropdown">
            <DynamicTableOfContents isMobile />
        </div>
    </pc-details>
</div>

<script>
    import type { PcDetails } from "placer-toolkit/dist/components/details/details.js";

    const mobileTOC = document.querySelector<HTMLDivElement>(".mobile-toc");
    const mobileDetails = mobileTOC?.querySelector<PcDetails>(
        ".mobile-toc pc-details",
    );

    mobileDetails?.addEventListener("click", (event) => {
        if ((event.target as HTMLElement).closest("a")) {
            mobileDetails.open = false;
        }
    });

    document.addEventListener("click", (event) => {
        const target = event.target as HTMLElement;

        if (mobileDetails?.open && !mobileTOC?.contains(target)) {
            mobileDetails.open = false;
        }
    });

    document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && mobileDetails?.open) {
            event.preventDefault();

            mobileDetails.open = false;
            mobileDetails.focus();
        }
    });
</script>

<style>
    .mobile-toc {
        position: sticky;
        inset-block-start: 3.5rem;
        inline-size: 100%;
        block-size: auto;
        background-color: var(--pc-color-surface-default);
        z-index: 2;
    }

    .mobile-toc pc-details {
        position: relative;
    }

    .mobile-toc pc-details::part(base) {
        position: relative;
        border: none;
        border-block-end: var(--pc-border-width-s) var(--pc-border-style)
            transparent;
        border-radius: 0;
        transition: border-color 0s ease-in-out;
    }

    .mobile-toc pc-details:not([open])::part(base) {
        border-color: var(--pc-color-surface-border);
        transition-delay: 0.2s;
    }

    .mobile-toc pc-details::part(header) {
        position: relative;
        padding-block: var(--pc-spacing-s);
        padding-inline: var(--pc-spacing-l);
        border-radius: 0;
        outline: none;
        cursor: default;
    }

    .mobile-toc pc-details::part(header):focus-visible {
        outline: var(--pc-focus-ring);
        outline-offset: calc(-1 * var(--pc-focus-ring-width));
        animation: inset-focus-ring-animation var(--pc-transition-medium)
            cubic-bezier(0.33, 1, 0.68, 1);
    }

    .mobile-toc pc-details::part(body) {
        position: absolute;
        inset-block-start: 100%;
        inset-inline-start: 0;
        inline-size: 100%;
        background-color: var(--pc-color-surface-default);
        border-block-end: var(--pc-border-width-s) var(--pc-border-style)
            var(--pc-color-surface-border);
        box-shadow: var(--pc-shadow-l);
    }

    .mobile-toc pc-details::part(summary-icon) {
        display: none;
    }

    .mobile-toc pc-details :global(.toc-scroll-fade) {
        max-block-size: 300px;
    }

    .mobile-toc
        pc-details
        :global(.toc-scroll-fade)::part(content):focus-visible {
        outline-offset: calc(-1 * var(--pc-focus-ring-width));
        animation: inset-focus-ring-animation var(--pc-transition-medium)
            cubic-bezier(0.33, 1, 0.68, 1);
    }

    .mobile-toc pc-details::part(content) {
        padding-block: 0;
        padding-inline: var(--pc-spacing-l);
    }

    .mobile-toc pc-details .toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75em;
        padding-block: calc(var(--pc-form-control-padding-inline) / 3);
        padding-inline: var(--pc-form-control-padding-inline);
        background-color: transparent;
        color: var(--pc-color-neutral-on-quiet);
        border: var(--pc-border-width-s) var(--pc-border-style)
            var(--pc-color-neutral-border-loud);
        border-radius: var(--pc-border-radius-m);
        font-size: var(--pc-font-size-s);
        font-weight: var(--pc-font-weight-bold);
        cursor: pointer;
        transition: all var(--pc-transition-fast) ease-in-out;
    }

    @media (hover: hover) {
        .mobile-toc pc-details .toggle:hover {
            background-color: color-mix(
                in oklab,
                var(--pc-color-neutral-fill-quiet),
                var(--pc-color-mix-hover)
            );
            color: color-mix(
                in oklab,
                var(--pc-color-neutral-on-quiet),
                var(--pc-color-mix-hover)
            );
        }
    }

    .mobile-toc pc-details .toggle:active {
        background-color: color-mix(
            in oklab,
            var(--pc-color-neutral-fill-quiet),
            var(--pc-color-mix-active)
        );
        color: color-mix(
            in oklab,
            var(--pc-color-neutral-on-quiet),
            var(--pc-color-mix-active)
        );
    }

    .mobile-toc pc-details .toggle pc-icon {
        transition: rotate var(--pc-transition-fast) ease-in-out;
    }

    .mobile-toc pc-details[open] .toggle pc-icon {
        rotate: 90deg;
    }

    .mobile-toc .toc-dropdown {
        line-height: var(--pc-line-height-dense);
    }

    @keyframes inset-focus-ring-animation {
        0% {
            outline-width: 0;
            outline-offset: 0;
        }

        50% {
            outline-width: calc(var(--pc-focus-ring-width) * 2);
            outline-offset: calc(-1 * (var(--pc-focus-ring-width) * 2));
        }

        100% {
            outline-width: var(--pc-focus-ring-width);
            outline-offset: calc(-1 * var(--pc-focus-ring-width));
        }
    }

    @media screen and (min-width: 1441px) {
        .mobile-toc {
            display: none;
        }
    }

    /* Odd section: Responsive “heights” */
    @media screen and (max-height: 500px) {
        .mobile-toc pc-details :global(.toc-scroll-fade) {
            max-block-size: calc(100dvh - 3.5rem - 3.125rem);
        }
    }
</style>
